name: Build Telegram Minimal (Skip All Problematic Submodules)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-telegram-minimal:
    runs-on: macos-latest
    
    steps:
    - name: Checkout our repository
      uses: actions/checkout@v4
      
    - name: Clone original Telegram iOS
      run: |
        echo "üì• Cloning original Telegram iOS..."
        git clone https://github.com/TelegramMessenger/Telegram-iOS.git original-telegram
        cd original-telegram
        
    - name: Completely disable problematic submodules
      run: |
        echo "‚ö†Ô∏è Completely disabling problematic submodules..."
        cd original-telegram
        
        # –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–∞–±–º–æ–¥—É–ª–∏ –∏–∑ .gitmodules
        echo "Removing problematic submodules from .gitmodules..."
        sed -i '' '/submodules\/TgVoipWebrtc\/tgcalls/d' .gitmodules || echo "tgcalls removal failed"
        sed -i '' '/submodules\/rlottie\/rlottie/d' .gitmodules || echo "rlottie removal failed"
        sed -i '' '/third-party\/webrtc\/webrtc/d' .gitmodules || echo "webrtc removal failed"
        
        # –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–∞–±–º–æ–¥—É–ª–∏ –∏–∑ .git/config
        echo "Removing from .git/config..."
        sed -i '' '/submodules\/TgVoipWebrtc\/tgcalls/d' .git/config || echo "tgcalls config removal failed"
        sed -i '' '/submodules\/rlottie\/rlottie/d' .git/config || echo "rlottie config removal failed"
        sed -i '' '/third-party\/webrtc\/webrtc/d' .git/config || echo "webrtc config removal failed"
        
        # –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –æ–Ω–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        echo "Removing problematic directories..."
        rm -rf submodules/TgVoipWebrtc/tgcalls || echo "tgcalls dir removal failed"
        rm -rf submodules/rlottie/rlottie || echo "rlottie dir removal failed"
        rm -rf third-party/webrtc/webrtc || echo "webrtc dir removal failed"
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–∞–±–º–æ–¥—É–ª–∏ –ø–æ –æ–¥–Ω–æ–º—É
        echo "Updating safe submodules one by one..."
        git submodule update --init build-system/bazel-rules || echo "bazel-rules failed"
        git submodule update --init submodules/LottieCpp || echo "LottieCpp failed"
        git submodule update --init third-party/XcodeGen || echo "XcodeGen failed"
        git submodule update --init third-party/dav1d || echo "dav1d failed"
        git submodule update --init third-party/libvpx || echo "libvpx failed"
        git submodule update --init third-party/td || echo "td failed"
        
        echo "‚úÖ Safe submodules updated"
        
    - name: Apply modifications
      run: |
        echo "üîß Applying modifications..."
        cd original-telegram
        # –ò–∑–º–µ–Ω—è–µ–º "Chats" –Ω–∞ "ch"
        sed -i '' 's/"DialogList.TabTitle" = "Chats";/"DialogList.TabTitle" = "ch";/g' Telegram/Telegram-iOS/en.lproj/Localizable.strings
        sed -i '' 's/"DialogList.Title" = "Chats";/"DialogList.Title" = "ch";/g' Telegram/Telegram-iOS/en.lproj/Localizable.strings
        echo "‚úÖ Modifications applied: 'Chats' ‚Üí 'ch'"
        
    - name: Verify changes
      run: |
        echo "üîç Verifying changes..."
        cd original-telegram
        grep -n "DialogList.TabTitle\|DialogList.Title" Telegram/Telegram-iOS/en.lproj/Localizable.strings
        
    - name: Setup Xcode
      run: |
        echo "üì± Setting up Xcode..."
        sudo xcode-select --switch /Applications/Xcode.app
        xcodebuild -version
        
    - name: Generate Xcode project
      run: |
        echo "üî® Generating Xcode project..."
        cd original-telegram
        python3 build-system/Make/Make.py \
          --cacheDir="$HOME/telegram-bazel-cache" \
          generateProject \
          --configurationPath=build-system/template_minimal_development_configuration.json
        
    - name: Build Telegram IPA
      run: |
        echo "üì¶ Building Telegram IPA for iOS devices..."
        cd original-telegram
        
        # –ö–æ–ø–∏—Ä—É–µ–º exportOptions.plist
        cp ../../ios/exportOptions.plist Telegram/Telegram-iOS/exportOptions.plist
        
        # –°–æ–±–∏—Ä–∞–µ–º –∞—Ä—Ö–∏–≤
        xcodebuild -project Telegram.xcodeproj -scheme Telegram -configuration Debug -archivePath build/Telegram.xcarchive archive
        
        # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º IPA
        xcodebuild -exportArchive -archivePath build/Telegram.xcarchive -exportPath build/ipa -exportOptionsPlist Telegram/Telegram-iOS/exportOptions.plist
        
    - name: Find IPA files
      run: |
        echo "üîç Looking for IPA files..."
        cd original-telegram
        find . -name "*.ipa" -type f
        ls -la build/ipa/ || echo "IPA directory not found"
        
    - name: Upload IPA file
      uses: actions/upload-artifact@v4
      with:
        name: telegram-minimal-ipa
        path: original-telegram/build/ipa/*.ipa
        if-no-files-found: warn
        
    - name: Success message
      run: |
        echo "üéâ Minimal Telegram IPA build completed!"
        echo "üì± Changes applied: 'Chats' ‚Üí 'ch'"
        echo "üì¶ IPA file ready for iOS devices"
        echo "üì• Download from: GitHub Actions ‚Üí Artifacts ‚Üí telegram-minimal-ipa"
        echo ""
        echo "‚úÖ You now have Telegram with 'ch' button!" 